<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Demo Banking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .dashboard-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .hero-section {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .quick-action {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }
        .quick-action:hover {
            background: #e9ecef;
            color: #007bff;
            transform: translateY(-3px);
        }
        .quick-action i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #007bff;
        }
        .account-status-active {
            color: #28a745;
        }
        .account-status-inactive {
            color: #dc3545;
        }
        .account-status-suspended {
            color: #ffc107;
        }
        .transaction-card {
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        .transaction-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .transaction-amount-positive {
            color: #28a745;
            font-weight: bold;
        }
        .transaction-amount-negative {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-university me-2"></i>
            <span th:text="${@environment.getProperty('spring.application.name', 'Demo Banking')}">Demo Banking</span>
        </a>
        <div class="navbar-nav ms-auto">
            <div class="nav-item dropdown" id="user-dropdown">
            </div>
        </div>
    </div>
</nav>

<div class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>Welcome to Your Banking Dashboard</h1>
                <p class="lead" th:text="${welcomeMessage}">Manage your finances with ease</p>
            </div>
            <div class="col-md-4 text-center">
                <i class="fas fa-chart-line" style="font-size: 4rem; opacity: 0.7;"></i>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row mb-3" th:if="${message}">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <span th:text="${message}">Server message</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <div class="row mb-3" th:if="${error}">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${error}">Error message</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <div id="dashboard-component"></div>

    <footer class="mt-5 text-center text-muted">
        <hr>
        <p>&copy; 2025 <span th:text="${@environment.getProperty('spring.application.name', 'Demo Banking')}">Demo Banking</span> |
            Server Time: <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm')}">Now</span>
        </p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="text/babel">
    const { useState, useEffect } = React;

    const UserDropdown = ({ user, onLogout }) => {
        return React.createElement('div', { className: 'dropdown' },
            React.createElement('a', {
                    className: 'nav-link dropdown-toggle text-white',
                    href: '#',
                    id: 'navbarDropdown',
                    role: 'button',
                    'data-bs-toggle': 'dropdown',
                    'aria-expanded': 'false'
                },
                React.createElement('i', { className: 'fas fa-user me-2' }),
                user ? `Welcome, ${user.firstName || user.username}` : 'User'
            ),
            React.createElement('ul', {
                    className: 'dropdown-menu dropdown-menu-end',
                    'aria-labelledby': 'navbarDropdown'
                },
                React.createElement('li', null,
                    React.createElement('a', { className: 'dropdown-item', href: '/profile' },
                        React.createElement('i', { className: 'fas fa-user me-2' }),
                        'Profile'
                    )
                ),
                React.createElement('li', null,
                    React.createElement('a', { className: 'dropdown-item', href: '/dashboard' },
                        React.createElement('i', { className: 'fas fa-tachometer-alt me-2' }),
                        'Dashboard'
                    )
                ),
                React.createElement('li', null,
                    React.createElement('hr', { className: 'dropdown-divider' })
                ),
                React.createElement('li', null,
                    React.createElement('button', {
                            className: 'dropdown-item text-danger',
                            onClick: onLogout,
                            type: 'button'
                        },
                        React.createElement('i', { className: 'fas fa-sign-out-alt me-2' }),
                        'Logout'
                    )
                )
            )
        );
    };

    const QuickActionCard = ({ icon, title, description, href, onClick }) => {
        return React.createElement('div', { className: 'col-md-6 col-lg-3 mb-4' },
            React.createElement('a', {
                    href: href,
                    onClick: onClick,
                    className: 'quick-action d-block'
                },
                React.createElement('i', { className: icon }),
                React.createElement('h6', { className: 'mt-2 mb-1' }, title),
                React.createElement('small', { className: 'text-muted' }, description)
            )
        );
    };

    const AccountSummaryCard = ({ account }) => {
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
        };

        const getStatusColor = (status) => {
            switch(status?.toLowerCase()) {
                case 'active': return 'account-status-active';
                case 'inactive': return 'account-status-inactive';
                case 'suspended': return 'account-status-suspended';
                default: return 'text-muted';
            }
        };

        return React.createElement('div', { className: 'col-md-6 col-lg-4 mb-4' },
            React.createElement('div', { className: 'dashboard-card card h-100' },
                React.createElement('div', { className: 'card-body' },
                    React.createElement('div', { className: 'd-flex justify-content-between align-items-center mb-3' },
                        React.createElement('h5', { className: 'card-title mb-0' }, React.createElement('i', { className: 'fas fa-credit-card me-2' }), 'Account'),
                        React.createElement('span', { className: `text-uppercase fw-bold ${getStatusColor(account.status)}` }, account.status)
                    ),
                    React.createElement('h3', { className: 'card-text fw-bold' }, formatCurrency(account.balance)),
                    React.createElement('p', { className: 'text-muted mb-2' }, `****${account.accountNumber?.slice(-4) || '0000'}`),
                    React.createElement('p', { className: 'text-muted mb-4' }, `Limit: ${formatCurrency(account.accountLimit)}`),
                    React.createElement('a', {
                        className: 'btn btn-primary btn-sm',
                        // FIX: Ensure account.id exists before navigating to prevent "undefined" error
                        onClick: () => {
                            if (account.accountNumber) {
                                window.location.href = `/account/${account.accountNumber}/details`;
                            } else {
                                console.error('Account number is missing, cannot navigate to details page.');
                                // Optionally, show an alert to the user
                                alert('Account details not available. Please try again later.');
                            }
                        }
                    }, 'View Details')
                )
            )
        );
    };

    // New TransactionCard Component for the dashboard
    const TransactionCard = ({ transaction }) => {
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
        };
        const getAmountClass = (type) => {
            return type?.toLowerCase() === 'deposit' || type?.toLowerCase() === 'transfer'
                ? 'transaction-amount-positive'
                : 'transaction-amount-negative';
        };

        const getTransactionIcon = (type) => {
            switch(type?.toLowerCase()) {
                case 'deposit': return 'fas fa-arrow-down text-success';
                case 'withdrawal': return 'fas fa-arrow-up text-danger';
                case 'transfer': return 'fas fa-exchange-alt text-primary';
                default: return 'fas fa-money-bill';
            }
        };

        const isDepositOrTransfer = transaction.type?.toLowerCase() === 'deposit' || transaction.type?.toLowerCase() === 'transfer';
        const amountDisplay = isDepositOrTransfer ? `+${formatCurrency(transaction.amount)}` : `-${formatCurrency(transaction.amount)}`;

        return React.createElement('div', { className: 'col-md-6 col-lg-4 mb-3' },
            React.createElement('div', { className: 'transaction-card card h-100' },
                React.createElement('div', { className: 'card-body' },
                    React.createElement('div', { className: 'd-flex justify-content-between align-items-center' },
                        React.createElement('div', null,
                            React.createElement('h6', { className: 'mb-0' }, React.createElement('i', { className: `${getTransactionIcon(transaction.type)} me-2` }), transaction.type),
                            React.createElement('small', { className: 'text-muted' }, new Date(transaction.createdDate).toLocaleDateString())
                        ),
                        React.createElement('span', { className: `fw-bold ${getAmountClass(transaction.type)}` }, amountDisplay)
                    )
                )
            )
        );
    };

    const Dashboard = () => {
        const [user, setUser] = useState(null);
        const [accounts, setAccounts] = useState([]);
        const [stats, setStats] = useState({
            totalBalance: 0,
            activeAccounts: 0,
            recentTransactions: 0
        });
        const [recentTransactions, setRecentTransactions] = useState([]);
        const [loading, setLoading] = useState(true);
        const [accountsLoading, setAccountsLoading] = useState(true);
        const [error, setError] = useState(null);

        useEffect(() => {
            checkAuthAndFetchDashboardData();
        }, []);

        const checkAuthAndFetchDashboardData = async () => {
            setLoading(true);
            try {
                // Step 1: Get the current user's security context (username)
                const userResponse = await fetch('/api/auth/me', { credentials: 'include' });
                if (!userResponse.ok) {
                    window.location.href = '/login';
                    return;
                }
                const userData = await userResponse.json();

                // Step 2: Use the username to fetch the full customer profile, which includes the ID
                const profileResponse = await fetch('/api/customers/profile', { credentials: 'include' });
                if (!profileResponse.ok) {
                    throw new Error('Failed to fetch customer profile.');
                }
                const profileData = await profileResponse.json();
                const customerProfile = profileData.data;
                setUser({ ...userData.data, id: customerProfile.id, firstName: customerProfile.firstName });

                // Step 3: Now that we have a valid customerId, proceed with fetching accounts and transactions
                await fetchAccountsAndTransactions(customerProfile.id);

            } catch (err) {
                console.error('Authentication check or data fetch failed:', err);
                // Redirect on authentication failure or show error message for other failures
                if (err.message.includes('Authentication') || err.message.includes('login')) {
                    window.location.href = '/login';
                } else {
                    setError('Failed to load dashboard data. Please try again.');
                }
            } finally {
                setLoading(false);
            }
        };

        // =========================================================================
        // FIXED: The `fetchAccountsAndTransactions` function now correctly uses
        // the `POST` request to the `searchSelfAccount` endpoint.
        // =========================================================================
        const fetchAccountsAndTransactions = async (customerId) => {
            setAccountsLoading(true);
            try {
                // Use the correct API endpoint and method for searching self accounts.
                const accountsResponse = await fetch(`/api/accounts/search/${customerId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    // The request body can be an empty JSON object to get all accounts.
                    body: JSON.stringify({})
                });

                if (!accountsResponse.ok) {
                    throw new Error('Failed to fetch accounts');
                }
                const accountsData = await accountsResponse.json();

                // The data you need is inside the 'data' and 'content' fields
                const fetchedAccounts = accountsData.data?.content || [];
                setAccounts(fetchedAccounts);
                updateStats(fetchedAccounts);

                // Fetch recent transactions for the first account if it exists
                if (fetchedAccounts.length > 0) {
                    const allTransactions = await Promise.all(
                        fetchedAccounts.map(acc =>
                        fetchRecentTransactions(acc.accountNumber))
                    )

                    const merged = allTransactions.flat().sort(
                        (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
                    );
                    setRecentTransactions(merged.slice(0, 5));
                    setStats(prevStats => ({
                        ...prevStats,
                        recentTransactions: merged.length
                    }));
                }

            } catch (err) {
                console.error('Failed to fetch accounts and transactions:', err);
                setError('Failed to load accounts and transactions. Please try again.');
            } finally {
                setAccountsLoading(false);
            }
        };

        const updateStats = (accounts) => {
            const totalBalance = accounts.reduce((sum, account) => sum + account.balance, 0);
            const activeAccounts = accounts.filter(account => account.status === 'ACTIVE').length;
            setStats(prevStats => ({
                ...prevStats,
                totalBalance: totalBalance,
                activeAccounts: activeAccounts,
            }));
        };

        // =========================================================================
        // FIXED: The `fetchRecentTransactions` function now correctly uses the `PUT`
        // method as defined in the backend API.
        // =========================================================================
        const fetchRecentTransactions = async (accountId) => {
            try {
                const response = await fetch(`api/transactions/account/accountnumber/${accountId}/search`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ page: 0, size: 5, sort: 'createdDate', direction: 'DESC' })
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.data.content || [];
                } else {
                    console.error('Failed to fetch transactions:', response.status);
                    return [];
                }
            } catch (error) {
                console.error('Network error fetching transactions:', error);
                return [];
            }
        };

        const handleLogout = async () => {
            try {
                const response = await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Logout failed. Please try again.');
                }
            } catch (error) {
                alert('An error occurred during logout. Please try again.');
            }
        };

        useEffect(() => {
            if (user) {
                const dropdownContainer = document.getElementById('user-dropdown');
                if (dropdownContainer) {
                    ReactDOM.render(
                        React.createElement(UserDropdown, { user, onLogout: handleLogout }),
                        dropdownContainer
                    );
                }
            }
        }, [user]);

        if (loading) {
            return React.createElement('div', { className: 'text-center' },
                React.createElement('div', { className: 'loading-spinner' }),
                React.createElement('p', null, 'Loading dashboard...')
            );
        }

        if (error) {
            return React.createElement('div', { className: 'text-center alert alert-danger' }, error);
        }

        return React.createElement('div', null,
            // Stats Overview Section
            React.createElement('div', { className: 'row' },
                React.createElement('h4', { className: 'mb-4' }, 'Stats Overview'),
                React.createElement('div', { className: 'col-md-4' },
                    React.createElement('div', { className: 'stat-card shadow-sm text-center' },
                        React.createElement('i', { className: 'fas fa-dollar-sign text-primary mb-3', style: { fontSize: '2rem' } }),
                        React.createElement('h3', { className: 'stat-number' }, new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(stats.totalBalance || 0)),
                        React.createElement('p', { className: 'text-muted' }, 'Total Balance')
                    )
                ),
                React.createElement('div', { className: 'col-md-4' },
                    React.createElement('div', { className: 'stat-card shadow-sm text-center' },
                        React.createElement('i', { className: 'fas fa-credit-card text-success mb-3', style: { fontSize: '2rem' } }),
                        React.createElement('h3', { className: 'stat-number' }, stats.activeAccounts),
                        React.createElement('p', { className: 'text-muted' }, 'Active Accounts')
                    )
                ),
                React.createElement('div', { className: 'col-md-4' },
                    React.createElement('div', { className: 'stat-card shadow-sm text-center' },
                        React.createElement('i', { className: 'fas fa-exchange-alt text-info mb-3', style: { fontSize: '2rem' } }),
                        React.createElement('h3', { className: 'stat-number' }, stats.recentTransactions),
                        React.createElement('p', { className: 'text-muted' }, 'Recent Transactions')
                    )
                )
            ),

            // Quick Actions Section
            React.createElement('div', { className: 'row mt-5' },
                React.createElement('h4', { className: 'mb-4' }, 'Quick Actions'),
                React.createElement(QuickActionCard, {
                    icon: 'fas fa-user-circle',
                    title: 'My Profile',
                    description: 'View and edit your personal information',
                    href: '/profile'
                }),
                React.createElement(QuickActionCard, {
                    icon: 'fas fa-plus',
                    title: 'New Account',
                    description: 'Open a new checking or savings account',
                    href: '#'
                }),
                React.createElement(QuickActionCard, {
                    icon: 'fas fa-exchange-alt',
                    title: 'Transfer Money',
                    description: 'Move funds between your accounts',
                    href: '#'
                }),
                React.createElement(QuickActionCard, {
                    icon: 'fas fa-file-invoice-dollar',
                    title: 'Statements',
                    description: 'Review your monthly statements',
                    href: '#'
                })
            ),

            // Your Accounts Section
            React.createElement('div', { className: 'row mt-5' },
                React.createElement('h4', { className: 'mb-4' }, 'Your Accounts'),
                accountsLoading ? (
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'loading-spinner' }),
                        React.createElement('p', null, 'Loading your accounts...')
                    )
                ) : accounts.length > 0 ? (
                    accounts.map(account =>
                        React.createElement(AccountSummaryCard, {
                            key: account.id || account.accountNumber,
                            account: account
                        })
                    )
                ) : (
                    React.createElement('div', { className: 'text-center py-5' },
                        React.createElement('i', { className: 'fas fa-credit-card text-muted', style: { fontSize: '3rem' } }),
                        React.createElement('h5', { className: 'text-muted mt-3' }, 'No accounts found'),
                        React.createElement('p', { className: 'text-muted' }, 'It looks like you don\'t have any accounts. Try opening one!')
                    )
                )
            ),

            // Recent Activity Section
            React.createElement('div', { className: 'row mt-5' },
                React.createElement('div', { className: 'col-12' },
                    React.createElement('div', { className: 'dashboard-card card' },
                        React.createElement('div', { className: 'card-header' },
                            React.createElement('h5', { className: 'mb-0' },
                                React.createElement('i', { className: 'fas fa-history me-2' }),
                                'Recent Activity'
                            )
                        ),
                        React.createElement('div', { className: 'card-body' },
                            recentTransactions.length > 0 ? (
                                React.createElement('div', { className: 'row' },
                                    recentTransactions.map(transaction =>
                                        React.createElement(TransactionCard, {
                                            key: transaction.id,
                                            transaction: transaction
                                        })
                                    )
                                )
                            ) : (
                                React.createElement('div', { className: 'text-center py-4 text-muted' },
                                    React.createElement('i', { className: 'fas fa-clock', style: { fontSize: '2rem' } }),
                                    React.createElement('p', { className: 'mt-3' }, 'No recent activity to display'),
                                    React.createElement('small', null, 'Your transactions will appear here once you start banking with us')
                                )
                            )
                        )
                    )
                )
            )
        );
    };

    ReactDOM.render(
        React.createElement(Dashboard),
        document.getElementById('dashboard-component')
    );
</script>

</body>
</html>