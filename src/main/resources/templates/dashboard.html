<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Demo Banking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .dashboard-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .hero-section {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .quick-action {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }
        .quick-action:hover {
            background: #e9ecef;
            color: #007bff;
            transform: translateY(-3px);
        }
        .quick-action i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #007bff;
        }
        .account-status-active {
            color: #28a745;
        }
        .account-status-inactive {
            color: #dc3545;
        }
        .account-status-suspended {
            color: #ffc107;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-university me-2"></i>
            <span th:text="${@environment.getProperty('spring.application.name', 'Demo Banking')}">Demo Banking</span>
        </a>
        <div class="navbar-nav ms-auto">
            <div class="nav-item dropdown" id="user-dropdown">
                <!-- Will be populated by React -->
            </div>
        </div>
    </div>
</nav>

<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>Welcome to Your Banking Dashboard</h1>
                <p class="lead" th:text="${welcomeMessage}">Manage your finances with ease</p>
            </div>
            <div class="col-md-4 text-center">
                <i class="fas fa-chart-line" style="font-size: 4rem; opacity: 0.7;"></i>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Server-side alerts -->
    <div class="row mb-3" th:if="${message}">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <span th:text="${message}">Server message</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <div class="row mb-3" th:if="${error}">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${error}">Error message</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <!-- React component will be mounted here -->
    <div id="dashboard-component"></div>

    <!-- Footer -->
    <footer class="mt-5 text-center text-muted">
        <hr>
        <p>&copy; 2025 <span th:text="${@environment.getProperty('spring.application.name', 'Demo Banking')}">Demo Banking</span> |
            Server Time: <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm')}">Now</span>
        </p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="text/babel">
    const { useState, useEffect } = React;

    // User dropdown component
    const UserDropdown = ({ user, onLogout }) => {
        return React.createElement('div', { className: 'dropdown' },
            React.createElement('a', {
                    className: 'nav-link dropdown-toggle text-white',
                    href: '#',
                    id: 'navbarDropdown',
                    role: 'button',
                    'data-bs-toggle': 'dropdown',
                    'aria-expanded': 'false'
                },
                React.createElement('i', { className: 'fas fa-user me-2' }),
                user ? `Welcome, ${user.firstName || user.username}` : 'User'
            ),
            React.createElement('ul', {
                    className: 'dropdown-menu dropdown-menu-end',
                    'aria-labelledby': 'navbarDropdown'
                },
                React.createElement('li', null,
                    React.createElement('a', { className: 'dropdown-item', href: '/profile' },
                        React.createElement('i', { className: 'fas fa-user me-2' }),
                        'Profile'
                    )
                ),
                React.createElement('li', null,
                    React.createElement('a', { className: 'dropdown-item', href: '/dashboard' },
                        React.createElement('i', { className: 'fas fa-tachometer-alt me-2' }),
                        'Dashboard'
                    )
                ),
                React.createElement('li', null,
                    React.createElement('hr', { className: 'dropdown-divider' })
                ),
                React.createElement('li', null,
                    React.createElement('button', {
                            className: 'dropdown-item text-danger',
                            onClick: onLogout,
                            type: 'button'
                        },
                        React.createElement('i', { className: 'fas fa-sign-out-alt me-2' }),
                        'Logout'
                    )
                )
            )
        );
    };

    // Quick Action Card
    const QuickActionCard = ({ icon, title, description, href, onClick }) => {
        const handleClick = (e) => {
            if (onClick) {
                e.preventDefault();
                onClick();
            }
        };

        return React.createElement('div', { className: 'col-md-6 col-lg-3 mb-4' },
            React.createElement('a', {
                    href: href || '#',
                    className: 'quick-action d-block text-decoration-none',
                    onClick: handleClick
                },
                React.createElement('i', { className: icon }),
                React.createElement('h5', { className: 'mt-2' }, title),
                React.createElement('p', { className: 'text-muted mb-0' }, description)
            )
        );
    };

    // Account Summary Card
    const AccountSummaryCard = ({ account }) => {
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        };

        const getStatusColor = (status) => {
            switch(status?.toLowerCase()) {
                case 'active': return 'account-status-active';
                case 'inactive': return 'account-status-inactive';
                case 'suspended': return 'account-status-suspended';
                default: return 'text-muted';
            }
        };

        return React.createElement('div', { className: 'col-md-6 col-xl-4 mb-4' },
            React.createElement('div', { className: 'dashboard-card card h-100' },
                React.createElement('div', { className: 'card-body' },
                    React.createElement('div', { className: 'd-flex justify-content-between align-items-start mb-3' },
                        React.createElement('div', null,
                            React.createElement('h6', { className: 'card-title text-muted mb-1' }, 'Account'),
                            React.createElement('small', { className: 'text-muted' },
                                `****${account.accountNumber?.slice(-4) || '0000'}`
                            )
                        ),
                        React.createElement('i', { className: 'fas fa-credit-card text-primary', style: { fontSize: '1.5rem' } })
                    ),
                    React.createElement('div', { className: 'mb-3' },
                        React.createElement('div', { className: 'stat-number' },
                            formatCurrency(account.balance)
                        ),
                        React.createElement('small', { className: 'text-muted' }, 'Available Balance')
                    ),
                    React.createElement('div', { className: 'mb-2' },
                        React.createElement('small', { className: 'text-muted' }, 'Limit: '),
                        React.createElement('span', { className: 'fw-bold' }, formatCurrency(account.accountLimit))
                    ),
                    React.createElement('div', { className: 'd-flex justify-content-between align-items-center' },
                        React.createElement('span', {
                                className: `fw-bold ${getStatusColor(account.status)}`
                            },
                            React.createElement('i', { className: 'fas fa-circle me-1', style: { fontSize: '0.5rem' } }),
                            account.status?.toUpperCase() || 'ACTIVE'
                        ),
                        React.createElement('button', {
                            className: 'btn btn-sm btn-outline-primary',
                            onClick: () => window.location.href = `/account/${account.id}/details`
                        }, 'View Details')
                    )
                )
            )
        );
    };

    // Main Dashboard Component
    const Dashboard = () => {
        const [user, setUser] = useState(null);
        const [accounts, setAccounts] = useState([]);
        const [stats, setStats] = useState({
            totalBalance: 0,
            accountCount: 0,
            recentTransactions: 0
        });
        const [loading, setLoading] = useState(true);
        const [accountsLoading, setAccountsLoading] = useState(false);
        const [error, setError] = useState('');

        // Check authentication and fetch data on component mount
        useEffect(() => {
            checkAuthAndFetchDashboardData();
        }, []);

        const checkAuthAndFetchDashboardData = async () => {
            try {
                // Check authentication first
                const authResponse = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!authResponse.ok) {
                    window.location.href = '/login';
                    return;
                }

                // Fetch dashboard data
                await fetchDashboardData();
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = '/login';
            }
        };

        // Fetch all dashboard data
        const fetchDashboardData = async () => {
            try {
                // Get user info first
                const userResponse = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (userResponse.ok) {
                    const userResult = await userResponse.json();

                    if (userResult.resultCode === '00') {
                        const userData = userResult.data;

                        // Try to get customer profile data
                        const customerResponse = await fetch('/api/customers/profile', {
                            method: 'GET',
                            credentials: 'include'
                        });

                        let customerData = {};
                        if (customerResponse.ok) {
                            const customerResult = await customerResponse.json();
                            if (customerResult.resultCode === '00') {
                                customerData = customerResult.data;
                            }
                        }

                        // Combine user and customer data
                        const combinedData = {
                            ...userData,
                            ...customerData
                        };

                        setUser(combinedData);

                        // Now fetch accounts with the user data available
                        if (combinedData.id) {
                            await fetchUserAccounts(combinedData);
                        } else {
                            setAccounts([]);
                            calculateStats([]);
                        }
                    } else {
                        setError('Failed to load user data: ' + userResult.resultMessage);
                    }
                } else if (userResponse.status === 401) {
                    window.location.href = '/login';
                } else {
                    setError('Failed to load user data');
                }
            } catch (error) {
                console.error('Dashboard data fetch error:', error);
                setError(`Network error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };

        // Fetch user accounts
        const fetchUserAccounts = async (userData) => {
            setAccountsLoading(true);
            try {
                const response = await fetch(`/api/accounts/customer/${userData.id}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.resultCode === '00') {
                        // Handle both single page and paginated responses
                        const accountData = result.data;
                        let accountsList = [];

                        if (accountData && accountData.content) {
                            // Paginated response
                            accountsList = accountData.content || [];
                        } else if (Array.isArray(accountData)) {
                            // Array response
                            accountsList = accountData;
                        }

                        setAccounts(accountsList);
                        calculateStats(accountsList);
                    } else {
                        console.warn('Failed to load accounts:', result.resultMessage);
                        setAccounts([]);
                        calculateStats([]);
                    }
                } else if (response.status === 404) {
                    setAccounts([]);
                    calculateStats([]);
                } else {
                    console.warn('Failed to load accounts:', response.status);
                    setAccounts([]);
                    calculateStats([]);
                }
            } catch (error) {
                console.error('Accounts fetch error:', error);
                setAccounts([]);
                calculateStats([]);
            } finally {
                setAccountsLoading(false);
            }
        };

        // Calculate dashboard statistics
        const calculateStats = (accountsList) => {
            const totalBalance = accountsList.reduce((sum, account) => sum + (account.balance || 0), 0);
            const activeAccounts = accountsList.filter(account =>
                account.status?.toLowerCase() === 'active'
            ).length;

            setStats({
                totalBalance: totalBalance,
                accountCount: activeAccounts,
                recentTransactions: 0 // This would come from a separate API call
            });
        };

        // Refresh dashboard data
        const refreshDashboard = async () => {
            setLoading(true);
            await fetchDashboardData();
        };

        const handleLogout = async () => {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        };

        // Mount user dropdown
        useEffect(() => {
            if (user) {
                const dropdownContainer = document.getElementById('user-dropdown');
                if (dropdownContainer) {
                    ReactDOM.render(
                        React.createElement(UserDropdown, {
                            user: user,
                            onLogout: handleLogout
                        }),
                        dropdownContainer
                    );
                }
            }
        }, [user]);

        if (loading) {
            return React.createElement('div', { className: 'text-center py-5' },
                React.createElement('div', { className: 'loading-spinner' }),
                React.createElement('p', null, 'Loading your dashboard...')
            );
        }

        if (error && !user) {
            return React.createElement('div', { className: 'alert alert-danger' },
                React.createElement('i', { className: 'fas fa-exclamation-triangle me-2' }),
                error
            );
        }

        return React.createElement('div', null,
            // Error display for non-critical errors
            error && React.createElement('div', { className: 'alert alert-warning alert-dismissible fade show mb-4' },
                React.createElement('i', { className: 'fas fa-exclamation-triangle me-2' }),
                error,
                React.createElement('button', {
                    type: 'button',
                    className: 'btn-close',
                    onClick: () => setError('')
                })
            ),

            // Stats Overview
            React.createElement('div', { className: 'row mb-5' },
                React.createElement('div', { className: 'col-12 mb-3' },
                    React.createElement('div', { className: 'd-flex justify-content-between align-items-center' },
                        React.createElement('h3', null,
                            React.createElement('i', { className: 'fas fa-chart-bar me-2' }),
                            'Account Overview'
                        ),
                        React.createElement('button', {
                                className: 'btn btn-outline-primary btn-sm',
                                onClick: refreshDashboard,
                                disabled: loading
                            },
                            React.createElement('i', { className: 'fas fa-sync-alt me-1' }),
                            loading ? 'Refreshing...' : 'Refresh'
                        )
                    )
                ),
                React.createElement('div', { className: 'col-md-4 mb-3' },
                    React.createElement('div', { className: 'stat-card text-center' },
                        React.createElement('i', { className: 'fas fa-wallet text-primary mb-3', style: { fontSize: '2rem' } }),
                        React.createElement('div', { className: 'stat-number' },
                            formatCurrency(stats.totalBalance)
                        ),
                        React.createElement('h6', { className: 'text-muted' }, 'Total Balance')
                    )
                ),
                React.createElement('div', { className: 'col-md-4 mb-3' },
                    React.createElement('div', { className: 'stat-card text-center' },
                        React.createElement('i', { className: 'fas fa-credit-card text-success mb-3', style: { fontSize: '2rem' } }),
                        React.createElement('div', { className: 'stat-number' }, stats.accountCount),
                        React.createElement('h6', { className: 'text-muted' }, 'Active Accounts')
                    )
                ),
                React.createElement('div', { className: 'col-md-4 mb-3' },
                    React.createElement('div', { className: 'stat-card text-center' },
                        React.createElement('i', { className: 'fas fa-exchange-alt text-warning mb-3', style: { fontSize: '2rem' } }),
                        React.createElement('div', { className: 'stat-number' }, stats.recentTransactions),
                        React.createElement('h6', { className: 'text-muted' }, 'Recent Transactions')
                    )
                )
            ),

            // Quick Actions
            React.createElement('div', { className: 'row mb-5' },
                React.createElement('div', { className: 'col-12 mb-4' },
                    React.createElement('h3', null,
                        React.createElement('i', { className: 'fas fa-bolt me-2' }),
                        'Quick Actions'
                    )
                ),
                React.createElement(QuickActionCard, {
                    icon: 'fas fa-user',
                    title: 'My Profile',
                    description: 'View and edit your personal information',
                    href: '/profile'
                }),
                React.createElement(QuickActionCard, {
                    icon: 'fas fa-plus-circle',
                    title: 'New Account',
                    description: 'Open a new banking account',
                    href: '/accounts/new'
                }),
                React.createElement(QuickActionCard, {
                    icon: 'fas fa-exchange-alt',
                    title: 'Transfer Money',
                    description: 'Send money to other accounts',
                    onClick: () => alert('Transfer feature coming soon!')
                }),
                React.createElement(QuickActionCard, {
                    icon: 'fas fa-file-alt',
                    title: 'Statements',
                    description: 'View your account statements',
                    onClick: () => alert('Statements feature coming soon!')
                })
            ),

            // Account Summary
            React.createElement('div', { className: 'row mb-5' },
                React.createElement('div', { className: 'col-12 mb-4' },
                    React.createElement('div', { className: 'd-flex justify-content-between align-items-center' },
                        React.createElement('h3', null,
                            React.createElement('i', { className: 'fas fa-credit-card me-2' }),
                            'Your Accounts'
                        ),
                        React.createElement('a', {
                                href: '/profile',
                                className: 'btn btn-outline-primary btn-sm'
                            },
                            React.createElement('i', { className: 'fas fa-eye me-1' }),
                            'View All'
                        )
                    )
                ),
                accountsLoading ? (
                    React.createElement('div', { className: 'col-12' },
                        React.createElement('div', { className: 'text-center py-4' },
                            React.createElement('div', { className: 'loading-spinner' }),
                            React.createElement('p', null, 'Loading accounts...')
                        )
                    )
                ) : accounts.length > 0 ? (
                    accounts.map(account =>
                        React.createElement(AccountSummaryCard, {
                            key: account.id || account.accountNumber,
                            account: account
                        })
                    )
                ) : (
                    React.createElement('div', { className: 'col-12' },
                        React.createElement('div', { className: 'dashboard-card card' },
                            React.createElement('div', { className: 'card-body text-center py-5' },
                                React.createElement('i', { className: 'fas fa-credit-card text-muted', style: { fontSize: '3rem' } }),
                                React.createElement('h5', { className: 'text-muted mt-3' }, 'No accounts found'),
                                React.createElement('p', { className: 'text-muted' },
                                    user?.hasCustomerProfile === false
                                        ? 'Complete your profile first to open accounts'
                                        : 'Get started by opening your first account'
                                ),
                                React.createElement('div', { className: 'mt-3' },
                                    user?.hasCustomerProfile === false ? (
                                        React.createElement('a', {
                                                href: '/profile',
                                                className: 'btn btn-primary me-2'
                                            },
                                            React.createElement('i', { className: 'fas fa-user-edit me-2' }),
                                            'Complete Profile'
                                        )
                                    ) : (
                                        React.createElement('a', {
                                                href: '/accounts/new',
                                                className: 'btn btn-primary'
                                            },
                                            React.createElement('i', { className: 'fas fa-plus me-2' }),
                                            'Open Account'
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            ),

            // Recent Activity
            React.createElement('div', { className: 'row' },
                React.createElement('div', { className: 'col-12' },
                    React.createElement('div', { className: 'dashboard-card card' },
                        React.createElement('div', { className: 'card-header' },
                            React.createElement('h5', { className: 'mb-0' },
                                React.createElement('i', { className: 'fas fa-history me-2' }),
                                'Recent Activity'
                            )
                        ),
                        React.createElement('div', { className: 'card-body' },
                            React.createElement('div', { className: 'text-center py-4 text-muted' },
                                React.createElement('i', { className: 'fas fa-clock', style: { fontSize: '2rem' } }),
                                React.createElement('p', { className: 'mt-3' }, 'No recent activity to display'),
                                React.createElement('small', null, 'Your transactions will appear here once you start banking with us')
                            )
                        )
                    )
                )
            )
        );
    };

    // Mount React component
    ReactDOM.render(
        React.createElement(Dashboard),
        document.getElementById('dashboard-component')
    );
</script>

</body>
</html>