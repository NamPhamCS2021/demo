<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<!-- Thymeleaf-rendered header -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">
            <span th:text="${@environment.getProperty('spring.application.name', 'Demo App')}">Demo App</span>
        </a>
        <div class="navbar-nav ms-auto">
                <span class="navbar-text" th:if="${currentUser}" th:text="'Welcome, ' + ${currentUser}">
                    Welcome, User
                </span>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Server-side messages -->
    <div class="row mb-3" th:if="${message}">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <span th:text="${message}">Server message</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <div class="row mb-3" th:if="${error}">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${error}">Error message</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <!-- React component will be mounted here -->
    <div id="login-component"></div>

    <!-- Thymeleaf-rendered footer -->
    <footer class="mt-5 text-center text-muted">
        <hr>
        <p>&copy; 2025 <span th:text="${@environment.getProperty('spring.application.name', 'Demo App')}">Demo App</span> |
            Server Time: <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm')}">Now</span>
        </p>
    </footer>
</div>

<!-- Bootstrap JS for dismissible alerts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="text/babel">
    const { useState, useEffect } = React;

    const LoginForm = ({ serverData }) => {
        const [credentials, setCredentials] = useState({
            username: '',
            password: ''
        });

        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [success, setSuccess] = useState('');
        const [validationErrors, setValidationErrors] = useState({});

        // Check if already authenticated on page load
        useEffect(() => {
            checkAuthentication();
        }, []);

        const checkAuthentication = async () => {
            try {
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include' // Include cookies
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.resultCode === '00') {
                        // Already authenticated, redirect to dashboard
                        window.location.href = '/dashboard';
                    }
                }
            } catch (error) {
                // Not authenticated, continue with login form
                console.log('User not authenticated');
            }
        };

        // Client-side validation
        const validateForm = () => {
            const errors = {};

            if (!credentials.username.trim()) {
                errors.username = 'Username is required';
            } else if (credentials.username.length < 3) {
                errors.username = 'Username must be at least 3 characters';
            }

            if (!credentials.password.trim()) {
                errors.password = 'Password is required';
            } else if (credentials.password.length < 6) {
                errors.password = 'Password must be at least 6 characters';
            }

            setValidationErrors(errors);
            return Object.keys(errors).length === 0;
        };

        const handleInputChange = (e) => {
            const { name, value } = e.target;
            setCredentials(prev => ({
                ...prev,
                [name]: value
            }));

            // Clear validation error when user starts typing
            if (validationErrors[name]) {
                setValidationErrors(prev => ({
                    ...prev,
                    [name]: ''
                }));
            }
        };

        const handleSubmit = async (e) => {
            e.preventDefault();

            if (!validateForm()) {
                return;
            }

            setLoading(true);
            setError('');
            setSuccess('');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include', // Important: Include cookies
                    body: JSON.stringify(credentials)
                });

                const result = await response.json();

                if (response.ok && result.resultCode === '00') {
                    setSuccess('Login successful! Redirecting...');

                    // Store token in localStorage as backup (if provided)
                    if (result.data && result.data.accessToken) {
                        localStorage.setItem('authToken', result.data.accessToken);
                    }

                    // Clear form
                    setCredentials({ username: '', password: '' });

                    // Redirect after success
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1500);
                } else {
                    setError(result.resultMessage || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                setError(`Network error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };

        // Demo function to fill form with test data
        const fillDemoData = () => {
            setCredentials({
                username: 'testuser',
                password: 'password123'
            });
        };

        return React.createElement('div', { className: 'row justify-content-center' },
            React.createElement('div', { className: 'col-md-6 col-lg-5' },
                React.createElement('div', { className: 'card shadow' },
                    React.createElement('div', { className: 'card-header bg-primary text-white' },
                        React.createElement('h4', { className: 'text-center mb-0' }, 'User Login')
                    ),
                    React.createElement('div', { className: 'card-body p-4' },
                        serverData?.welcomeMessage && React.createElement('div', { className: 'alert alert-info' }, serverData.welcomeMessage),
                        React.createElement('form', { onSubmit: handleSubmit, noValidate: true },
                            React.createElement('div', { className: 'mb-3' },
                                React.createElement('label', { htmlFor: 'username', className: 'form-label' }, 'Username'),
                                React.createElement('input', {
                                    type: 'text',
                                    className: `form-control ${validationErrors.username ? 'is-invalid' : ''}`,
                                    id: 'username',
                                    name: 'username',
                                    value: credentials.username,
                                    onChange: handleInputChange,
                                    disabled: loading,
                                    placeholder: 'Enter your username'
                                }),
                                validationErrors.username && React.createElement('div', { className: 'invalid-feedback' }, validationErrors.username)
                            ),
                            React.createElement('div', { className: 'mb-3' },
                                React.createElement('label', { htmlFor: 'password', className: 'form-label' }, 'Password'),
                                React.createElement('input', {
                                    type: 'password',
                                    className: `form-control ${validationErrors.password ? 'is-invalid' : ''}`,
                                    id: 'password',
                                    name: 'password',
                                    value: credentials.password,
                                    onChange: handleInputChange,
                                    disabled: loading,
                                    placeholder: 'Enter your password'
                                }),
                                validationErrors.password && React.createElement('div', { className: 'invalid-feedback' }, validationErrors.password)
                            ),
                            React.createElement('div', { className: 'd-grid gap-2' },
                                React.createElement('button', {
                                    type: 'submit',
                                    className: 'btn btn-primary btn-lg',
                                    disabled: loading
                                }, loading ? 'Logging in...' : 'Login'),
                                React.createElement('button', {
                                    type: 'button',
                                    className: 'btn btn-outline-secondary',
                                    onClick: fillDemoData,
                                    disabled: loading
                                }, 'Fill Demo Data')
                            )
                        ),
                        error && React.createElement('div', { className: 'alert alert-danger mt-3' }, error),
                        success && React.createElement('div', { className: 'alert alert-success mt-3' }, success)
                    )
                )
            )
        );
    };

    // Get server-side data passed from Thymeleaf (safely)
    const serverData = {
        welcomeMessage: /*[[${welcomeMessage}]]*/ 'Please enter your credentials'
    };

    // Mount React component
    ReactDOM.render(React.createElement(LoginForm, { serverData: serverData }), document.getElementById('login-component'));
</script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>