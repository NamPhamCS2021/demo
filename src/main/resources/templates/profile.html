</script>
</body>
</html><html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfileOld - Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .profile-avatar {
            width: 120px;
            height: 120px;
            object-fit: cover;
        }
        .profile-card, .account-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .profile-card:hover, .account-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .account-balance {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .account-number {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .account-status-active {
            color: #28a745;
        }
        .account-status-inactive {
            color: #dc3545;
        }
        .account-status-suspended {
            color: #ffc107;
        }
        .account-type-badge {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
<!-- Server-side navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-user-circle me-2"></i>
            <span th:text="${@environment.getProperty('spring.application.name', 'Demo App')}">Demo App</span>
        </a>
        <div class="navbar-nav ms-auto">
            <div class="nav-item dropdown" id="user-dropdown">
                <!-- Will be populated by React -->
            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Server-side alerts -->
    <div class="row mb-3" th:if="${message}">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <span th:text="${message}">Server message</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <div class="row mb-3" th:if="${error}">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${error}">Error message</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <!-- React components will be mounted here -->
    <div id="profile-component"></div>

    <!-- Footer -->
    <footer class="mt-5 text-center text-muted">
        <hr>
        <p>&copy; 2025 <span th:text="${@environment.getProperty('spring.application.name', 'Demo App')}">Demo App</span> |
            Server Time: <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm')}">Now</span>
        </p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="text/babel">
    const { useState, useEffect } = React;

    // User dropdown component for navigation
    const UserDropdown = ({ user, onLogout }) => {
        return React.createElement('div', { className: 'dropdown' },
            React.createElement('a', {
                    className: 'nav-link dropdown-toggle text-white',
                    href: '#',
                    id: 'navbarDropdown',
                    role: 'button',
                    'data-bs-toggle': 'dropdown',
                    'aria-expanded': 'false'
                },
                React.createElement('i', { className: 'fas fa-user me-2' }),
                user ? `Welcome, ${user.username}` : 'User'
            ),
            React.createElement('ul', {
                    className: 'dropdown-menu dropdown-menu-end',
                    'aria-labelledby': 'navbarDropdown'
                },
                React.createElement('li', null,
                    React.createElement('a', { className: 'dropdown-item', href: '/profile' },
                        React.createElement('i', { className: 'fas fa-user me-2' }),
                        'ProfileOld'
                    )
                ),
                React.createElement('li', null,
                    React.createElement('a', { className: 'dropdown-item', href: '/dashboard' },
                        React.createElement('i', { className: 'fas fa-tachometer-alt me-2' }),
                        'Dashboard'
                    )
                ),
                React.createElement('li', null,
                    React.createElement('hr', { className: 'dropdown-divider' })
                ),
                React.createElement('li', null,
                    React.createElement('button', {
                            className: 'dropdown-item text-danger',
                            onClick: onLogout,
                            type: 'button'
                        },
                        React.createElement('i', { className: 'fas fa-sign-out-alt me-2' }),
                        'Logout'
                    )
                )
            )
        );
    };

    // Account Card Component
    const AccountCard = ({ account, onViewDetails }) => {
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        };

        const getStatusColor = (status) => {
            switch(status?.toLowerCase()) {
                case 'active': return 'account-status-active';
                case 'inactive': return 'account-status-inactive';
                case 'suspended': return 'account-status-suspended';
                default: return 'text-muted';
            }
        };

        return React.createElement('div', { className: 'col-md-6 col-lg-4 mb-4' },
            React.createElement('div', { className: 'account-card card shadow-sm h-100' },
                React.createElement('div', { className: 'card-body' },
                    React.createElement('div', { className: 'd-flex justify-content-between align-items-start mb-3' },
                        React.createElement('div', null,
                            React.createElement('h6', { className: 'card-title mb-1' },
                                React.createElement('i', { className: 'fas fa-credit-card me-2' }),
                                'Account'
                            ),
                            React.createElement('p', { className: 'account-number text-muted mb-1' },
                                `****${account.accountNumber?.slice(-4) || '0000'}`
                            )
                        ),
                        React.createElement('span', {
                            className: 'badge bg-primary account-type-badge'
                        }, 'Account')
                    ),

                    React.createElement('div', { className: 'mb-3' },
                        React.createElement('div', { className: 'account-balance text-center' },
                            formatCurrency(account.balance)
                        ),
                        React.createElement('small', { className: 'text-muted d-block text-center' }, 'Current Balance')
                    ),

                    React.createElement('div', { className: 'mb-3' },
                        React.createElement('div', { className: 'd-flex justify-content-between align-items-center' },
                            React.createElement('small', { className: 'text-muted' }, 'Status:'),
                            React.createElement('span', {
                                    className: `fw-bold ${getStatusColor(account.status)}`
                                },
                                React.createElement('i', { className: 'fas fa-circle me-1', style: { fontSize: '0.5rem' } }),
                                account.status || 'Unknown'
                            )
                        )
                    ),

                    React.createElement('div', { className: 'mb-3' },
                        React.createElement('small', { className: 'text-muted' }, 'Limit: '),
                        React.createElement('span', { className: 'fw-bold' }, formatCurrency(account.accountLimit))
                    ),

                    React.createElement('div', { className: 'mt-auto' },
                        React.createElement('button', {
                                className: 'btn btn-outline-primary btn-sm w-100',
                                onClick: () => onViewDetails(account)
                            },
                            React.createElement('i', { className: 'fas fa-eye me-2' }),
                            'View Details & Transactions'
                        )
                    )
                )
            )
        );
    };

    // Main profile component
    const UserProfile = ({ serverData }) => {
        const [user, setUser] = useState(null);
        const [accounts, setAccounts] = useState([]);
        const [loading, setLoading] = useState(true);
        const [accountsLoading, setAccountsLoading] = useState(false);
        const [error, setError] = useState('');
        const [editing, setEditing] = useState(false);
        const [editForm, setEditForm] = useState({});

        // Check authentication on component mount
        useEffect(() => {
            checkAuthAndFetchProfile();
        }, []);

        const checkAuthAndFetchProfile = async () => {
            try {
                // Check authentication first
                const authResponse = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!authResponse.ok) {
                    window.location.href = '/login';
                    return;
                }

                // Fetch user info
                await fetchUserProfile();
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = '/login';
            }
        };

        // Fetch user and customer data
        const fetchUserProfile = async () => {
            try {
                // Get user info (username, role)
                const userResponse = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (userResponse.ok) {
                    const userResult = await userResponse.json();

                    if (userResult.resultCode === '00') {
                        const userData = userResult.data;

                        // Then try to get customer profile data
                        const customerResponse = await fetch('/api/customers/profile', {
                            method: 'GET',
                            credentials: 'include'
                        });

                        let customerData = {};
                        let hasCustomerProfile = false;

                        if (customerResponse.ok) {
                            const customerResult = await customerResponse.json();
                            if (customerResult.resultCode === '00') {
                                customerData = customerResult.data;
                                hasCustomerProfile = true;
                            }
                        } else if (customerResponse.status !== 404) {
                            console.warn('Failed to load customer profile:', customerResponse.status);
                        }

                        // Combine user and customer data
                        const combinedData = {
                            ...userData,
                            ...customerData,
                            hasCustomerProfile: hasCustomerProfile
                        };

                        setUser(combinedData);
                        setEditForm(combinedData);

                        // Now fetch accounts with the user data available
                        if (combinedData.id) {
                            await fetchUserAccountsForUser(combinedData);
                        }
                    } else {
                        setError('Failed to load user data: ' + userResult.resultMessage);
                    }
                } else if (userResponse.status === 401) {
                    window.location.href = '/login';
                } else {
                    setError('Failed to load user data');
                }
            } catch (error) {
                console.error('Profile fetch error:', error);
                setError(`Network error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };

        // Helper function to fetch accounts with user data
        const fetchUserAccountsForUser = async (userData) => {
            setAccountsLoading(true);
            try {
                const response = await fetch(`/api/accounts/customer/${userData.id}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.resultCode === '00') {
                        // Handle both single page and paginated responses
                        const accountData = result.data;
                        if (accountData && accountData.content) {
                            // Paginated response
                            setAccounts(accountData.content || []);
                        } else if (Array.isArray(accountData)) {
                            // Array response
                            setAccounts(accountData);
                        } else {
                            setAccounts([]);
                        }
                    } else {
                        console.warn('Failed to load accounts:', result.resultMessage);
                        setAccounts([]);
                    }
                } else if (response.status === 404) {
                    setAccounts([]);
                } else {
                    console.warn('Failed to load accounts:', response.status);
                    setAccounts([]);
                }
            } catch (error) {
                console.error('Accounts fetch error:', error);
                setAccounts([]);
            } finally {
                setAccountsLoading(false);
            }
        };

        // Fetch user accounts
        const fetchUserAccounts = async () => {
            setAccountsLoading(true);
            try {
                if (!user?.id) {
                    console.warn('No customer ID available');
                    setAccounts([]);
                    setAccountsLoading(false);
                    return;
                }

                const response = await fetch(`/api/accounts/customer/${user.id}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.resultCode === '00') {
                        const accountData = result.data;
                        if (accountData && accountData.content) {
                            setAccounts(accountData.content || []);
                        } else if (Array.isArray(accountData)) {
                            setAccounts(accountData);
                        } else {
                            setAccounts([]);
                        }
                    } else {
                        console.warn('Failed to load accounts:', result.resultMessage);
                        setAccounts([]);
                    }
                } else if (response.status === 404) {
                    setAccounts([]);
                } else {
                    console.warn('Failed to load accounts:', response.status);
                    setAccounts([]);
                }
            } catch (error) {
                console.error('Accounts fetch error:', error);
                setAccounts([]);
            } finally {
                setAccountsLoading(false);
            }
        };

        // Handle customer profile create/update
        const handleUpdateProfile = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError('');

            try {
                const customerData = {
                    firstName: editForm.firstName || '',
                    lastName: editForm.lastName || '',
                    email: editForm.email || '',
                    phoneNumber: editForm.phoneNumber || '',
                    type: editForm.type || 'INDIVIDUAL'
                };

                const method = user.hasCustomerProfile ? 'PUT' : 'POST';
                const url = '/api/customers/profile';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(customerData)
                });

                const result = await response.json();

                if (response.ok && result.resultCode === '00') {
                    const updatedUser = {
                        ...user,
                        ...result.data,
                        hasCustomerProfile: true
                    };

                    setUser(updatedUser);
                    setEditing(false);
                    setError('');
                } else {
                    setError(result.resultMessage || 'Update failed');
                }
            } catch (error) {
                setError(`Network error: ${error.message}`);
            } finally {
                setLoading(false);
            }
        };

        // Handle account details navigation
        const handleViewAccountDetails = (account) => {
            window.location.href = `/account/${account.accountNumber}/details`;
        };

        // Handle logout
        const handleLogout = async () => {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        };

        // Handle form input changes
        const handleInputChange = (e) => {
            const { name, value } = e.target;
            setEditForm(prev => ({
                ...prev,
                [name]: value
            }));
        };

        // Mount user dropdown in navigation
        useEffect(() => {
            if (user) {
                const dropdownContainer = document.getElementById('user-dropdown');
                if (dropdownContainer) {
                    ReactDOM.render(
                        React.createElement(UserDropdown, {
                            user: user,
                            onLogout: handleLogout
                        }),
                        dropdownContainer
                    );
                }
            }
        }, [user]);

        if (loading) {
            return React.createElement('div', { className: 'text-center' },
                React.createElement('div', { className: 'loading-spinner' }),
                React.createElement('p', null, 'Loading profile...')
            );
        }

        if (error && !user) {
            return React.createElement('div', { className: 'alert alert-danger' },
                React.createElement('i', { className: 'fas fa-exclamation-triangle me-2' }),
                error
            );
        }

        return React.createElement('div', { className: 'row' },
            React.createElement('div', { className: 'col-12' },
                // ProfileOld header
                React.createElement('div', { className: 'profile-card card shadow mb-4' },
                    React.createElement('div', { className: 'card-body text-center' },
                        React.createElement('img', {
                            src: user?.avatar || 'https://via.placeholder.com/120/007bff/ffffff?text=USER',
                            alt: 'Profile Avatar',
                            className: 'profile-avatar rounded-circle mb-3'
                        }),
                        React.createElement('h2', { className: 'card-title' },
                            user?.firstName && user?.lastName
                                ? `${user.firstName} ${user.lastName}`
                                : user?.username
                        ),
                        React.createElement('p', { className: 'text-muted' }, user?.email || 'No email provided'),
                        React.createElement('div', { className: 'badge bg-primary mb-3' },
                            React.createElement('i', { className: 'fas fa-user-tag me-1' }),
                            user?.type || user?.role || 'User'
                        ),
                        React.createElement('div', { className: 'mt-3' },
                            React.createElement('button', {
                                    className: 'btn btn-outline-primary me-2',
                                    onClick: () => setEditing(!editing)
                                },
                                React.createElement('i', { className: editing ? 'fas fa-times' : 'fas fa-edit' }),
                                editing ? ' Cancel' : ' Edit Profile'
                            )
                        )
                    )
                ),

                // Accounts Section
                React.createElement('div', { className: 'card shadow mb-4' },
                    React.createElement('div', { className: 'card-header d-flex justify-content-between align-items-center' },
                        React.createElement('h5', { className: 'mb-0' },
                            React.createElement('i', { className: 'fas fa-credit-card me-2' }),
                            'My Accounts'
                        ),
                        React.createElement('button', {
                                className: 'btn btn-sm btn-outline-primary',
                                onClick: fetchUserAccounts,
                                disabled: accountsLoading
                            },
                            React.createElement('i', { className: 'fas fa-sync-alt me-1' }),
                            accountsLoading ? 'Refreshing...' : 'Refresh'
                        )
                    ),
                    React.createElement('div', { className: 'card-body' },
                        accountsLoading ? (
                            React.createElement('div', { className: 'text-center py-4' },
                                React.createElement('div', { className: 'loading-spinner' }),
                                React.createElement('p', null, 'Loading accounts...')
                            )
                        ) : accounts.length > 0 ? (
                            React.createElement('div', { className: 'row' },
                                accounts.map(account =>
                                    React.createElement(AccountCard, {
                                        key: account.accountNumber,
                                        account: account,
                                        onViewDetails: handleViewAccountDetails
                                    })
                                )
                            )
                        ) : (
                            React.createElement('div', { className: 'text-center py-4' },
                                React.createElement('i', { className: 'fas fa-credit-card text-muted', style: { fontSize: '3rem' } }),
                                React.createElement('p', { className: 'text-muted mt-3' }, 'No accounts found.'),
                                React.createElement('button', {
                                        className: 'btn btn-primary',
                                        onClick: () => window.location.href = '/accounts/new'
                                    },
                                    React.createElement('i', { className: 'fas fa-plus me-2' }),
                                    'Open New Account'
                                )
                            )
                        )
                    )
                ),

                // ProfileOld details
                React.createElement('div', { className: 'card shadow' },
                    React.createElement('div', { className: 'card-header' },
                        React.createElement('h5', { className: 'mb-0' },
                            React.createElement('i', { className: 'fas fa-info-circle me-2' }),
                            'Profile Information'
                        )
                    ),
                    React.createElement('div', { className: 'card-body' },
                        error && React.createElement('div', { className: 'alert alert-danger' }, error),

                        editing ? (
                            // Edit form
                            React.createElement('form', { onSubmit: handleUpdateProfile },
                                React.createElement('div', { className: 'row mb-3' },
                                    React.createElement('div', { className: 'col-md-6' },
                                        React.createElement('label', { className: 'form-label' }, 'First Name'),
                                        React.createElement('input', {
                                            type: 'text',
                                            className: 'form-control',
                                            name: 'firstName',
                                            value: editForm.firstName || '',
                                            onChange: handleInputChange,
                                            required: true
                                        })
                                    ),
                                    React.createElement('div', { className: 'col-md-6' },
                                        React.createElement('label', { className: 'form-label' }, 'Last Name'),
                                        React.createElement('input', {
                                            type: 'text',
                                            className: 'form-control',
                                            name: 'lastName',
                                            value: editForm.lastName || '',
                                            onChange: handleInputChange,
                                            required: true
                                        })
                                    )
                                ),
                                React.createElement('div', { className: 'row mb-3' },
                                    React.createElement('div', { className: 'col-md-6' },
                                        React.createElement('label', { className: 'form-label' }, 'Email'),
                                        React.createElement('input', {
                                            type: 'email',
                                            className: 'form-control',
                                            name: 'email',
                                            value: editForm.email || '',
                                            onChange: handleInputChange,
                                            required: true
                                        })
                                    ),
                                    React.createElement('div', { className: 'col-md-6' },
                                        React.createElement('label', { className: 'form-label' }, 'Phone Number'),
                                        React.createElement('input', {
                                            type: 'tel',
                                            className: 'form-control',
                                            name: 'phoneNumber',
                                            value: editForm.phoneNumber || '',
                                            onChange: handleInputChange,
                                            required: true
                                        })
                                    )
                                ),
                                React.createElement('div', { className: 'mb-3' },
                                    React.createElement('label', { className: 'form-label' }, 'Customer Type'),
                                    React.createElement('select', {
                                            className: 'form-control',
                                            name: 'type',
                                            value: editForm.type || 'INDIVIDUAL',
                                            onChange: handleInputChange
                                        },
                                        React.createElement('option', { value: 'INDIVIDUAL' }, 'Individual'),
                                        React.createElement('option', { value: 'BUSINESS' }, 'Business'),
                                        React.createElement('option', { value: 'CORPORATE' }, 'Corporate')
                                    )
                                ),
                                React.createElement('div', { className: 'text-end' },
                                    React.createElement('button', {
                                        type: 'button',
                                        className: 'btn btn-secondary me-2',
                                        onClick: () => {
                                            setEditing(false);
                                            setEditForm(user);
                                            setError('');
                                        }
                                    }, 'Cancel'),
                                    React.createElement('button', {
                                        type: 'submit',
                                        className: 'btn btn-primary',
                                        disabled: loading
                                    }, loading ? 'Saving...' : 'Save Changes')
                                )
                            )
                        ) : (
                            // View mode
                            React.createElement('div', null,
                                React.createElement('div', { className: 'row mb-3' },
                                    React.createElement('div', { className: 'col-sm-3' },
                                        React.createElement('strong', null, 'Username:')
                                    ),
                                    React.createElement('div', { className: 'col-sm-9' }, user?.username || 'Not provided')
                                ),
                                React.createElement('div', { className: 'row mb-3' },
                                    React.createElement('div', { className: 'col-sm-3' },
                                        React.createElement('strong', null, 'First Name:')
                                    ),
                                    React.createElement('div', { className: 'col-sm-9' }, user?.firstName || 'Not provided')
                                ),
                                React.createElement('div', { className: 'row mb-3' },
                                    React.createElement('div', { className: 'col-sm-3' },
                                        React.createElement('strong', null, 'Last Name:')
                                    ),
                                    React.createElement('div', { className: 'col-sm-9' }, user?.lastName || 'Not provided')
                                ),
                                React.createElement('div', { className: 'row mb-3' },
                                    React.createElement('div', { className: 'col-sm-3' },
                                        React.createElement('strong', null, 'Email:')
                                    ),
                                    React.createElement('div', { className: 'col-sm-9' }, user?.email || 'Not provided')
                                ),
                                React.createElement('div', { className: 'row mb-3' },
                                    React.createElement('div', { className: 'col-sm-3' },
                                        React.createElement('strong', null, 'Phone Number:')
                                    ),
                                    React.createElement('div', { className: 'col-sm-9' }, user?.phoneNumber || 'Not provided')
                                ),
                                React.createElement('div', { className: 'row mb-3' },
                                    React.createElement('div', { className: 'col-sm-3' },
                                        React.createElement('strong', null, 'Customer Type:')
                                    ),
                                    React.createElement('div', { className: 'col-sm-9' },
                                        React.createElement('span', {
                                            className: `badge ${user?.type === 'BUSINESS' ? 'bg-success' : user?.type === 'CORPORATE' ? 'bg-warning' : 'bg-info'}`
                                        }, user?.type || 'Not specified')
                                    )
                                ),
                                React.createElement('div', { className: 'row mb-3' },
                                    React.createElement('div', { className: 'col-sm-3' },
                                        React.createElement('strong', null, 'Customer Since:')
                                    ),
                                    React.createElement('div', { className: 'col-sm-9' },
                                        user?.createdDate ? new Date(user.createdDate).toLocaleDateString() : 'Unknown'
                                    )
                                ),
                                !user?.hasCustomerProfile && React.createElement('div', { className: 'alert alert-info' },
                                    React.createElement('i', { className: 'fas fa-info-circle me-2' }),
                                    'Complete your profile by clicking "Edit Profile" to add your personal information.'
                                )
                            )
                        )
                    )
                )
            )
        );
    };

    // Get server-side data
    const serverData = {
        welcomeMessage: /*[[${welcomeMessage}]]*/ null
    };

    // Mount React component
    ReactDOM.render(
        React.createElement(UserProfile, { serverData: serverData }),
        document.getElementById('profile-component')
    );
</script>
</body>
</html>